error() {
  echo "USAGE	 : verif_sancus_mac <branch> [-v]"
  echo "Example	 : sim master -v"
  exit 1
}
count=0
visual=0
while [[ $# -gt 0 ]]; do
  case $1 in
    -*)
      getopts 'v' OPTION;
      case "$OPTION" in
        v)
          visual=1
          ;;
        ?)
          echo "ERROR	 : Wrong flag"
          error
          ;;
      esac
      shift
      ;;
    *)
      count=$((count+1))
      if [ $count -gt 2 ]; then
        echo "ERROR	 : too many arguments"
        error
      fi
      branch="$1"
      shift
      ;;
  esac
done

if [ $count == 0 ]; then
  echo "ERROR	 : missing argument"
  error
fi

if [ ! -d "../sancus_evaluation/$branch" ]; then
  echo "ERROR	 : branch does not exist"
  directory="../sancus_evaluation/"
  folders=()
  for folder in "$directory"/*/; do
    if [ -d "$folder" ] && [ "$(basename "$folder")" != "specifications" ]; then
      folders+=("$(basename "$folder" .${folder##*.})")
    fi
  done
  echo "Available branches:"
  echo " ${folders[@]/%/$'  \n'}" | column
  exit 1
fi



# #!/bin/bash
rm -rf build-verif
mkdir -p build-verif

cp ../openmsp430/core/rtl/verilog/openMSP430_undefines.v ./build-verif/
cp ../sancus_evaluation/$branch/*.v ./build-verif/
cp ../sancus_evaluation/*.v ./build-verif/

# # Specification
cp ../sancus_evaluation/specifications/ltl_specs.smv ./build-verif


cd ../verification-tools/verilog2smv-1.1.3/
./verilog2smv.sh ../../scripts/build-verif/wrapper.v ../../scripts/build-verif/generated.smv wrapper
cd -

# #sed -i "s/IVAR/VAR/g" ./build-verif/generated.smv # Hacky here since IVAR doesnt work properly
echo '#include "ltl_specs.smv"' >> ./build-verif/generated.smv

./../verification-tools/NuSMV-2.6.0-Linux/bin/NuSMV -pre cpp ./build-verif/generated.smv | tee ./build-verif/NuSMV_output.txt

sed -i 's/\"//g' ./build-verif/NuSMV_output.txt

if [ $visual == 1 ]; then
  echo "Opening the GUI"
  java -jar ../verification-tools/nusmv_counterexample_visualizer/jars/visualizer-gui.jar ./build-verif/NuSMV_output.txt
fi

# rm -rf build-verif
